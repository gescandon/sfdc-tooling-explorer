<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SFDC Tooling Explorer - Who touched the Code!</title>

    <!-- Bootstrap -->
    <link href="js/bootstrap/css/bootstrap.min.css" rel="stylesheet">


  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  <script src="/js/sfdcMock.js"></script>
  <script src="/js/tooling.js"></script>
  <script>
	function map(fn, a)
	    {
	        for (i = 0; i < a.length; i++)
	        {
	            a[i] = fn(a[i]);
	        }
	    }
	    
	    
	function reduce(fn, a, init)
	    {
	        var s = init;
	        for (i = a.length - 1; i >= 0  ; i--)
	            s = fn( s, a[i] );
	        return s;
	    }

	toolingApexClasses.records.sort(function(a, b){
	    var keyA = new Date(a.LastModifiedDate),
	    keyB = new Date(b.LastModifiedDate);
	    // Compare the 2 dates
	    if(keyA < keyB) return -1;
	    if(keyA > keyB) return 1;
	    return 0;
	});

	function load() {
		console.log($("#datatype").val());
		var idesc = $("#datatype").val().indexOf('Describe');
		console.log(idesc);
		if (idesc > 1 ) {
			loadDescription();
		} else {
			loadCollection();
		}
	}

	function loadDescription() {
		var query = "/tooling?type=sobjects&var=" + $("datatype").val();
		console.log("tooling query: " + query);
		var desc = $.get(query, function( response ) {
			console.log("# DESCRIBE RESULT");
			console.log(desc);
			$("#madlib").html('<pre>' + JSON.stringify(desc,null,2) + '</pre>');
		}); 


	}

	function loadCollection() {
		var datatype = $("#datatype").val();
		var mycollection;
		var query = "/tooling?type=query&var=" + $("datatype").val();
		var desc = $.get(query, function( response ) {
			console.log("# DESCRIBE RESULT");
			console.log(desc);
			mycollection = response.records;
			mycollection.sort();
			var toolsHtml = reduce(function(s, x) {
			return s + "<tr><td>" + x[i].LastModifiedDate + "</td><td>" + x[i].Name + "</td><td>" + x[i].LastModifiedById + "</td></tr>";},
			mycollection,
			"<table class='table'><thead><tr><td>LastModifiedDate</td><td>Name</td><td>LastModifiedById</td></tr></thead>");		}
		if (datatype == 'ApexCodeCoverage') {
			mycollection = toolingApexCodeCoverage.records;
			mycollection.sort();
			var toolsHtml = reduce(function(s, x) {
			var percentCoverage = Math.round(100 * (x[i].NumLinesCovered / (x[i].NumLinesCovered + x[i].NumLinesUncovered)));
			return s + "<tr><td>" + x[i].Id + "</td><td>" + x[i].ApexClassOrTriggerId + "</td><td>" + percentCoverage + "</td><td>" + x[i].LastModifiedDate + "</td></tr>";},
			mycollection,
			"<table class='table'><thead><tr><td>Id</td><td>ApexClassOrTriggerId</td><td>Coverage</td><td>LastModifiedById</td></tr></thead>");		}
		if (datatype == 'User') {
			// collect user ids
			var userSet = {}
			userSet = reduce(function(s, x) {
				s[x.LastModifiedById] = x.LastModifiedById;
				return s;
				},
				toolingApexClasses.records,
				userSet);

			var userCsv =  '';
				for(var key in userSet){
				  userCsv += "Id+='" + key + "'+OR+";
				}
			console.log(userCsv);
		}
		
		$("#madlib").html(toolsHtml + "</table>");
		}); 
			

	}
	$( document ).ready(function() {
		load();
	});
/*
	$( document ).ready(function() {
		$.get( "/tooling?type=query&var=ApexClass", function( response ) {
		  toolingResp(response);
		}); 
	});
*/
	</script>
</head>
<body>
<div id="container">
	<div class="col-md-12">
			<h1>SFDC Tooling Explorer - Who touched the Code!</h1>
	</div>
	<div class="col-md-2">
		<input type="hidden" id="request-type" value="query">
	</div>
	<div class="col-md-2"></div>
	 <select id="datatype" onchange="load();" value="ApexClass">
	 	<option value="ApexClass">ApexClass</option>
	 	<option value="ApexCodeCoverage">ApexCodeCoverage</option>
	 	<option value="User">User</option>
	 	<option value="ApexCodeCoverage/describe">ApexCodeCoverageDescribe</option>
	 	<option value="User/describe">UserDescribe</option>
	 </select>

	</div>
	<div class="col-md-8">
		<div id="request-url"></div>
	</div>	
</div>
    <div id="explore-out" class="section"></div>
    
    <div id="mock-response" class="section"></div>

</body></html>